# Maintainer: Alexey Pavlov <alexpux@gmail.com>
# Contributor: Ray Donnelly <mingw.android@gmail.com>

pkgbase=msys2-runtime
pkgname=('msys2-runtime' 'msys2-runtime-devel')
pkgver=3.3.4
pkgrel=2
pkgdesc="Cygwin POSIX emulation engine"
arch=('i686' 'x86_64')
url="https://www.cygwin.com/"
license=('GPL')
groups=('base')
makedepends=('cocom'
             'texinfo'
             'git'
             'perl'
             'gcc'
             'make'
             'mingw-w64-cross-crt-git'
             'mingw-w64-cross-gcc'
             'mingw-w64-cross-zlib'
             'zlib-devel'
             'gettext-devel'
             'libiconv-devel'
             'diffutils')
# options=('debug' '!strip')
source=('msys2-runtime'::git://sourceware.org/git/newlib-cygwin.git#tag=cygwin-${pkgver//./_}-release
        0001-Add-MSYS2-triplet.patch
        0002-Fix-msys-library-name-in-import-libraries.patch
        0003-Rename-dll-from-cygwin-to-msys.patch
        0004-Add-functionality-for-converting-UNIX-paths-in-argum.patch
        0005-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
        0006-Move-root-to-usr.-Change-sorting-mount-points.-By-de.patch
        0007-Instead-of-creating-Cygwin-symlinks-use-deep-copy-by.patch
        0008-Automatically-rewrite-TERM-msys-to-TERM-cygwin-With-.patch
        0009-Do-not-convert-environment-for-strace.patch
        0010-Special-case-for-converting-root-directory-to-have-t.patch
        0011-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
        0012-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
        0013-strace.cc-Don-t-set-MSYS-noglob.patch
        0014-Add-debugging-for-build_argv.patch
        0015-Add-debugging-for-strace-make_command_line.patch
        0016-environ.cc-New-facility-environment-variable-MSYS2_E.patch
        0017-Fix-native-symbolic-link-spawn-passing-wrong-arg0.patch
        0018-QueryUnbiasedInterruptTime-must-be-load-from-kernel3.patch
        0019-strace-quiet-be-really-quiet.patch
        0020-Default-to-disable_pcon.patch
        0021-Introduce-the-enable_pcon-value-for-MSYS.patch
        0022-popen-call-usr-bin-sh-instead-of-bin-sh.patch
        0023-CI-add-a-GHA-for-doing-a-basic-build-test.patch
        0024-Set-up-a-GitHub-Action-to-keep-in-sync-with-Cygwin.patch
        0025-Expose-full-command-lines-to-other-Win32-processes-b.patch
        0026-Disable-the-cygwin-GitHub-workflow.patch
        0027-Do-not-show-Error-dialogs-by-default.patch
        0028-Add-a-helper-to-obtain-a-function-s-address-in-kerne.patch
        0029-Emulate-GenerateConsoleCtrlEvent-upon-Ctrl-C.patch
        0030-kill-kill-Win32-processes-more-gently.patch
        0031-Cygwin-make-option-for-native-inner-link-handling.patch
        0032-docs-skip-building-texinfo-and-PDF-files.patch
        0033-install-libs-depend-on-the-toollibs.patch
        0034-POSIX-ify-the-SHELL-variable.patch
        0035-Handle-ORIGINAL_PATH-just-like-PATH.patch
        0036-Fix-incorrect-path-conversion-trailing-slash.patch
        0037-Pass-environment-variables-with-empty-values.patch
        0038-Handle-8-bit-characters-under-LOCALE-C.patch
        0039-Mention-the-extremely-useful-small_printf-function.patch
        0040-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
        0041-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
        0042-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
        0043-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
        0044-Leave-Git-s-name-and-message-arguments-alone-please.patch
        0045-Leave-paths-containing-any-special-characters-alone.patch
        0046-Leave-paths-containing-alone.patch
        0047-Skip-posix-to-windows-conversion-when-is-seen.patch
        0048-Also-leave-Git-s-rev-.-name-syntax-alone.patch
        0049-Arguments-starting-with-are-no-paths.patch
        0050-Prevent-scp-style-arguments-from-being-mangled.patch
        0051-Fixed-path-converting-with-non-ascii-char.patch
        0052-path-conversion-Introduce-ability-to-switch-off-conv.patch
        0053-Allow-overriding-the-home-directory-via-the-HOME-var.patch
        0054-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
        0055-Respect-the-db_home-env-setting-under-more-circumsta.patch
        0056-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
        0057-Make-paths-WCS-MBS-conversion-explicit.patch
        0058-Use-MB_CUR_MAX-6-by-default.patch
        0059-Do-not-try-to-sync-with-Cygwin.patch
        0060-Stop-enabling-virtual-terminal-input-with-MSYS-disab.patch
        0061-fixup-Stop-enabling-virtual-terminal-input-with-MSYS.patch
        0062-Cygwin-console-Maintain-ENABLE_-INSERT-QUICK_EDIT-_M.patch
        0063-Cygwin-pty-console-Fix-Ctrl-C-handling-for-non-cygwi.patch
        0064-Cygwin-pty-Pass-Ctrl-Z-EOF-to-non-cygwin-apps-with-d.patch
        0065-Cygwin-pty-Prevent-deadlock-on-echo-output.patch
        0066-Cygwin-pty-Revise-the-code-to-wait-for-completion-of.patch
        0067-Cygwin-pty-Discard-input-in-from_master_nat-pipe-on-.patch
        0068-Cygwin-pty-Fix-a-bug-in-tty_min-segpgid.patch
        0069-Cygwin-console-Fix-console-mode-for-non-cygwin-infer.patch
        0070-Cygwin-console-Set-console-mode-even-if-stdin-stdout.patch
        0071-Implicitly-support-the-dev-fd-symlink-and-friends.patch)
sha256sums=('SKIP'
            '3d00c77cd023bee3861d1eaa89deecb0fc277ec3bb13e317de3dddc3b1eca094'
            '0b0ca0c86d118ac8842c0ca9d0df28453ee5b613d76ade265169d5524b3004d8'
            '25c6a930654f5dd484165e3a1251b5fda11578e0c17e836ae42b543dbf0ea126'
            'e620e0065299b993c169d98f77b29f9e23e4e582e84472447d2c4ca0cef6d3e3'
            '906e9ba93564a7d541a748c88d7179fe0d69a74ab830a8f35cd3d63610a355e4'
            '1641ae186bc63636001553e0e3bd6fe45d0316ca386611412d82d46e9b9796fb'
            '1f34360bcb44a6db873dba86e18fa80f82e0e6c6699116f984695382a0f19093'
            'a2758e9b9c20123c671720a6018db7715b90c1074a2a9fa912072053c65eee71'
            'dea7b47aae6852a66a060c459a41fb36aaa1639723e4a475b14bd2c9e3131f81'
            '62ff93317a6e64a5cdefb8bd7ecef59b9bb9e2172f48f1cc9543efd9195a6f4a'
            'ca1fb84b0c75aefdb03afa7f2631ffc420244575b68a028f5ccdaeee62b7f0e8'
            'b377ffc2a019f134ad339fba3f1e75b0131bfcdaa086954414594bea6d6f2d54'
            'bc965865af9d7a0f43a3879d77e912c1acb84c40fe55c014564d03061dbdfc35'
            'c572ac7a7a73f7e8801725178a53d2a30637663a8c767aa629371e8c01dabdf6'
            '9dc416ac280078aa6320f2bd543d7e495b6c9a38e846de5698f7ba20de17a153'
            '11fa53166f648255d18fea66df7b5ad32e049344c5801089869540d1fd3bba5a'
            '422e67a4ccddfd9c731e3461ac1ef74e0c5dbf1823cbcf28075cc4901080546f'
            'd1290d15df781914a22fa45b70959621a9596c1d136f8a0432ddf71477a79dba'
            '2da6ef4c361b29ffba9da0f0ac082884615ef70223caf261ed3524b337cc8558'
            '4d8d4a16a457f34343942a665f79d375b5d241fb3ddaecdbcff6950bdd1455f3'
            '7cb85299a1af9a2a8f53ba6503995582e1682507b8415eb7c17de24dde12a994'
            'cd77c18983f31c007f1a17c491edcfad98f6bfc3a7189a69b227907232c17269'
            '73f8a161611d113ac5cbddae65b8779f8af4e94e5bdaa3c4d95afc88f1808be0'
            'b5a67e6358fc05a36a0cd3301572a511ff9172492a3b46a1c51d67a7c849b0c3'
            'd74b5ebd4149befd5e7bd3e78ada43e3052f80f2af48a1920b2f5a58fc035d88'
            '6d8d8fdb816989390e8ae8cf18b31f44610489b3da9e13ee1ffd0eebe55d4971'
            'a160354bb1160f443b0fdb0ef2aac6131a504ab07a29458477272d9549efe3c8'
            'e90f577f8dfd1115a018cae6b1c3cada160d4140d0363f6e0c762672d78bf0e6'
            '39b4eb0cd85b684d1793f44975e5c66d741fac62187162910011080a23d82f1f'
            '214205e0f1f1eb035abc8c6f9f9afa0c9ecb327a7d746b8b77c4eb91aa350d14'
            '9f7e08fdca6254c6d53cd2a5c4bbc72fff6805e62a6c3100c3bd5e835561b440'
            'c2c5132a335dd188dc4542229867dd892c9517c97f872b39e83e8b7f32196d1a'
            '24ac5d96976620457de0fc8639d84fe89f2105c43d218318405d7eab636fce45'
            'c31afa168ee953b555adb05caa724ac55ec6ec56543551dbce4f0a0508c97cbd'
            '35b431e9087a30bcb8452efa0f24e59126995454984d780ae21c8d6ef4737930'
            'c783030efc79ec3b6c017a46d2677e93f6c3ba2298d3c80bc4338461bf06cc14'
            '7113701daf646b29981b653d834be126260c9330d084418b876b3bdbaa2d9bef'
            'ba96bee12bced71fed528f936404909c30ed3fa10342a55a94235b1806472fbc'
            '64836e7593917832fe7fba4d57602ec8f2dd6cbe2e1835b439082d2c6194cb94'
            'dd13894ae4fd2272eef4e01934fed8d1e9bce5d64952d8a953de454b845de538'
            'e6908d9977b2019acd490f9057767fd2f038e8ba34ab56727eb0dfe352b9c83e'
            '0998a92ceeea018ca2d7fc30fba9e56f161c6a3d75cc7d20fcd69c6e55c059e4'
            '8d623b834a7d93ee390ea7ffc2a4b9eb4959415d667160342839da29526f595f'
            '60e0a4a25016f6b7a117801bdfa265c8d7dfaaf7c517ff9346c78c32ae029e58'
            'e54bcad1cadb70d418451ea519fce47c3a66d64c28ef6f777413a430dceb6298'
            'b5916847cdc2032e99c22ad56a14c0e2d87025cd1c470a2740cd925669e86e53'
            'd55724577abd5431b31ac751af97b6f479b7ef8814cf7abfbc41ca998bd4a0d0'
            'd898287b2472bc4a1119048a392231a562a30e8f86711affc7d70cd019249344'
            '8c21ea2e7452ef2bed5225a73468dd24461efa14634646487d2b044f3e5e45fe'
            'b8bde01bc29ba1d14a9a8b16971194dadfdfb6d5d868549733d7091ed5e06ddd'
            'a4763a3e22115c262f9f6ba54814f7d0ef6cd51087989257fde1d00d1fee4e3e'
            '21cbdadf02ca6f7ed25e90808ee01df56d0c589dd127a1b6614f771faadd1dc2'
            '32f23d1cc4aebd5d0a81f438e94038d1558b2c66df856622952697603aafc547'
            '568582b3e350a91371d3d5eb1e813d33db0413e1dc36446bffd5982de9d2eb55'
            '1e7b453fc2c1868dd13e3358321d89389b06a076707e36d8e03f79a00003d6c7'
            'dc62968fe74ee687a8bab4bc7ad3fa7ab28162a9f037d1b8ca192d6c8759aa56'
            'aa9de2a51c6297fa13744f566c7391f61b48e24c0f5ed2185d9033f6ea4fd6b9'
            '3f99efc620a18c1ab7bb64b3f7593d622591dd3bffd3e4afb83fd5f4dd1c7244'
            '14e6550454559a578480a042e8271e1400327ded85dd30cb778f6bc8ebf4a4a0'
            '6feb9c61effb16c747f2f429920d2cb3b3a4fa4c40a1ad9956454bb6b2e351fd'
            'ee1d708f0a7a1ab9458e485170ef320ab2c0337e42ba2914669afae0f324639a'
            '0a96ebea8e28927aa4c933affdb18ad0ffdf4c0add2526d897a7be1bb6cc5f68'
            'ecd5c9c5eee65e8536fd35985737826d2a08335d3baddfcc91b1d6be16bd8cc7'
            'b105267f8863d6d47af3b386f64b2cf70a0aefc8f4397ec6319ffb48386264a5'
            '498a81c8e714beb1fffa7524222f2c0e343961e9b9ec78986c8cd32d7026da9f'
            '25f82bcdbf756f3657588467a3fa06c98323446f3162a40045663c49dfea6368'
            '395f0f406581ba2de28594d52532fbb80663f564a44b307434b5f91407c55b8c'
            '87a89ab6c11daaa95eb2804c6f19d9c7640821a0a7c57d0edeb22b3a14c403c7'
            'b4d0a6693dec32c599cc0dc137207e705a81ca8567e381e50456dd5132ab7932'
            '0c1c0f9e84e00c8b759ec2b00eeb08f31a87ce7abf8454399b84d06761ec3939'
            '9424de93d34f0a14cd8c380c9cb6a8033fda3d52a8fc4ee8e8dc4fb6247d1714')

# Helper macro to help make tasks easier #
del_file_exists() {
  for _fname in "$@"
  do
    if [ -f $_fname ]; then
      rm -rf $_fname
    fi
  done
}

prepare() {
  cd "${srcdir}"/msys2-runtime
  if test true != "$(git config core.symlinks)"
  then
    git config core.symlinks true &&
    /usr/bin/git reset --hard
  fi
  if test false != "$(git config core.autocrlf)"
  then
    git config core.autocrlf false &&
    rm "$(git rev-parse --git-path index)" &&
    /usr/bin/git reset --hard
  fi
  del_file_exists winsup/cygwin/msys2_path_conv.cc \
    winsup/cygwin/msys2_path_conv.h
  git am --committer-date-is-author-date "${srcdir}"/0001-Add-MSYS2-triplet.patch
  git am --committer-date-is-author-date "${srcdir}"/0002-Fix-msys-library-name-in-import-libraries.patch
  git am --committer-date-is-author-date "${srcdir}"/0003-Rename-dll-from-cygwin-to-msys.patch
  git am --committer-date-is-author-date "${srcdir}"/0004-Add-functionality-for-converting-UNIX-paths-in-argum.patch
  git am --committer-date-is-author-date "${srcdir}"/0005-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
  git am --committer-date-is-author-date "${srcdir}"/0006-Move-root-to-usr.-Change-sorting-mount-points.-By-de.patch
  git am --committer-date-is-author-date "${srcdir}"/0007-Instead-of-creating-Cygwin-symlinks-use-deep-copy-by.patch
  git am --committer-date-is-author-date "${srcdir}"/0008-Automatically-rewrite-TERM-msys-to-TERM-cygwin-With-.patch
  git am --committer-date-is-author-date "${srcdir}"/0009-Do-not-convert-environment-for-strace.patch
  git am --committer-date-is-author-date "${srcdir}"/0010-Special-case-for-converting-root-directory-to-have-t.patch
  git am --committer-date-is-author-date "${srcdir}"/0011-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
  git am --committer-date-is-author-date "${srcdir}"/0012-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
  git am --committer-date-is-author-date "${srcdir}"/0013-strace.cc-Don-t-set-MSYS-noglob.patch
  git am --committer-date-is-author-date "${srcdir}"/0014-Add-debugging-for-build_argv.patch
  git am --committer-date-is-author-date "${srcdir}"/0015-Add-debugging-for-strace-make_command_line.patch
  git am --committer-date-is-author-date "${srcdir}"/0016-environ.cc-New-facility-environment-variable-MSYS2_E.patch
  git am --committer-date-is-author-date "${srcdir}"/0017-Fix-native-symbolic-link-spawn-passing-wrong-arg0.patch
  git am --committer-date-is-author-date "${srcdir}"/0018-QueryUnbiasedInterruptTime-must-be-load-from-kernel3.patch
  git am --committer-date-is-author-date "${srcdir}"/0019-strace-quiet-be-really-quiet.patch
  git am --committer-date-is-author-date "${srcdir}"/0020-Default-to-disable_pcon.patch
  git am --committer-date-is-author-date "${srcdir}"/0021-Introduce-the-enable_pcon-value-for-MSYS.patch
  git am --committer-date-is-author-date "${srcdir}"/0022-popen-call-usr-bin-sh-instead-of-bin-sh.patch
  git am --committer-date-is-author-date "${srcdir}"/0023-CI-add-a-GHA-for-doing-a-basic-build-test.patch
  git am --committer-date-is-author-date "${srcdir}"/0024-Set-up-a-GitHub-Action-to-keep-in-sync-with-Cygwin.patch
  git am --committer-date-is-author-date "${srcdir}"/0025-Expose-full-command-lines-to-other-Win32-processes-b.patch
  git am --committer-date-is-author-date "${srcdir}"/0026-Disable-the-cygwin-GitHub-workflow.patch
  git am --committer-date-is-author-date "${srcdir}"/0027-Do-not-show-Error-dialogs-by-default.patch
  git am --committer-date-is-author-date "${srcdir}"/0028-Add-a-helper-to-obtain-a-function-s-address-in-kerne.patch
  git am --committer-date-is-author-date "${srcdir}"/0029-Emulate-GenerateConsoleCtrlEvent-upon-Ctrl-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0030-kill-kill-Win32-processes-more-gently.patch
  git am --committer-date-is-author-date "${srcdir}"/0031-Cygwin-make-option-for-native-inner-link-handling.patch
  git am --committer-date-is-author-date "${srcdir}"/0032-docs-skip-building-texinfo-and-PDF-files.patch
  git am --committer-date-is-author-date "${srcdir}"/0033-install-libs-depend-on-the-toollibs.patch
  git am --committer-date-is-author-date "${srcdir}"/0034-POSIX-ify-the-SHELL-variable.patch
  git am --committer-date-is-author-date "${srcdir}"/0035-Handle-ORIGINAL_PATH-just-like-PATH.patch
  git am --committer-date-is-author-date "${srcdir}"/0036-Fix-incorrect-path-conversion-trailing-slash.patch
  git am --committer-date-is-author-date "${srcdir}"/0037-Pass-environment-variables-with-empty-values.patch
  git am --committer-date-is-author-date "${srcdir}"/0038-Handle-8-bit-characters-under-LOCALE-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0039-Mention-the-extremely-useful-small_printf-function.patch
  git am --committer-date-is-author-date "${srcdir}"/0040-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
  git am --committer-date-is-author-date "${srcdir}"/0041-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
  git am --committer-date-is-author-date "${srcdir}"/0042-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
  git am --committer-date-is-author-date "${srcdir}"/0043-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0044-Leave-Git-s-name-and-message-arguments-alone-please.patch
  git am --committer-date-is-author-date "${srcdir}"/0045-Leave-paths-containing-any-special-characters-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0046-Leave-paths-containing-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0047-Skip-posix-to-windows-conversion-when-is-seen.patch
  git am --committer-date-is-author-date "${srcdir}"/0048-Also-leave-Git-s-rev-.-name-syntax-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0049-Arguments-starting-with-are-no-paths.patch
  git am --committer-date-is-author-date "${srcdir}"/0050-Prevent-scp-style-arguments-from-being-mangled.patch
  git am --committer-date-is-author-date "${srcdir}"/0051-Fixed-path-converting-with-non-ascii-char.patch
  git am --committer-date-is-author-date "${srcdir}"/0052-path-conversion-Introduce-ability-to-switch-off-conv.patch
  git am --committer-date-is-author-date "${srcdir}"/0053-Allow-overriding-the-home-directory-via-the-HOME-var.patch
  git am --committer-date-is-author-date "${srcdir}"/0054-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
  git am --committer-date-is-author-date "${srcdir}"/0055-Respect-the-db_home-env-setting-under-more-circumsta.patch
  git am --committer-date-is-author-date "${srcdir}"/0056-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
  git am --committer-date-is-author-date "${srcdir}"/0057-Make-paths-WCS-MBS-conversion-explicit.patch
  git am --committer-date-is-author-date "${srcdir}"/0058-Use-MB_CUR_MAX-6-by-default.patch
  git am --committer-date-is-author-date "${srcdir}"/0059-Do-not-try-to-sync-with-Cygwin.patch
  git am --committer-date-is-author-date "${srcdir}"/0060-Stop-enabling-virtual-terminal-input-with-MSYS-disab.patch
  git am --committer-date-is-author-date "${srcdir}"/0061-fixup-Stop-enabling-virtual-terminal-input-with-MSYS.patch
  git am --committer-date-is-author-date "${srcdir}"/0062-Cygwin-console-Maintain-ENABLE_-INSERT-QUICK_EDIT-_M.patch
  git am --committer-date-is-author-date "${srcdir}"/0063-Cygwin-pty-console-Fix-Ctrl-C-handling-for-non-cygwi.patch
  git am --committer-date-is-author-date "${srcdir}"/0064-Cygwin-pty-Pass-Ctrl-Z-EOF-to-non-cygwin-apps-with-d.patch
  git am --committer-date-is-author-date "${srcdir}"/0065-Cygwin-pty-Prevent-deadlock-on-echo-output.patch
  git am --committer-date-is-author-date "${srcdir}"/0066-Cygwin-pty-Revise-the-code-to-wait-for-completion-of.patch
  git am --committer-date-is-author-date "${srcdir}"/0067-Cygwin-pty-Discard-input-in-from_master_nat-pipe-on-.patch
  git am --committer-date-is-author-date "${srcdir}"/0068-Cygwin-pty-Fix-a-bug-in-tty_min-segpgid.patch
  git am --committer-date-is-author-date "${srcdir}"/0069-Cygwin-console-Fix-console-mode-for-non-cygwin-infer.patch
  git am --committer-date-is-author-date "${srcdir}"/0070-Cygwin-console-Set-console-mode-even-if-stdin-stdout.patch
  git am --committer-date-is-author-date "${srcdir}"/0071-Implicitly-support-the-dev-fd-symlink-and-friends.patch
}

build() {
  [[ -d "${srcdir}"/build-${CHOST} ]] && rm -rf "${srcdir}"/build-${CHOST}
  mkdir -p "${srcdir}"/build-${CHOST} && cd "${srcdir}"/build-${CHOST}

  # Gives more verbose compile output when debugging.
  local -a extra_config
  if check_option "debug" "y"; then
    export CCWRAP_VERBOSE=1
    OPTIM="-O0"
    extra_config+=(--enable-debugging)
  else
    OPTIM="-O2"
  fi

  CFLAGS="$OPTIM -pipe -ggdb -Wno-error=deprecated -Wno-error=stringop-truncation -Wno-error=missing-attributes -Wno-error=maybe-uninitialized" #-Wno-error=class-memaccess
  CXXFLAGS="$OPTIM -pipe -ggdb -Wno-error=deprecated -Wno-error=stringop-truncation -Wno-error=missing-attributes -Wno-error=maybe-uninitialized" #-Wno-error=class-memaccess

  (cd "${srcdir}/msys2-runtime/winsup" && ./autogen.sh)

  "${srcdir}"/msys2-runtime/configure \
    --prefix=/usr \
    --build=${CHOST} \
    --sysconfdir=/etc \
    "${extra_config[@]}"
  LC_ALL=C make

  if test -n "$SIGNTOOL"
  then
    eval "$SIGNTOOL" \
      ${PWD}/${CHOST}/winsup/cygwin/msys0.dll \
      ${PWD}/${CHOST}/winsup/utils/*.exe ${PWD}/${CHOST}/winsup/utils/mingw/*.exe
  fi

  LC_ALL=C make -j1 DESTDIR="${srcdir}"/dest install

  #pushd ${CHOST}/winsup/cygwin > /dev/null
  #LANG=C make libmsys2_s.a
  #cp libmsys2_s.a "${srcdir}"/dest/usr/${CHOST}/lib/
  #popd > /dev/null

  rm -rf "${srcdir}"/dest/etc
}

package_msys2-runtime() {
  pkgdesc="Posix emulation engine for Windows"
  groups=('base')
  options=('!strip')
  conflicts=('catgets' 'libcatgets')
  replaces=('catgets' 'libcatgets')
  #install=msys2-runtime.install

  mkdir -p "${pkgdir}"/usr
  cp -rf "${srcdir}"/dest/usr/bin "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/bin/msys-2.0.dbg
  rm -f "${pkgdir}"/usr/bin/cyglsa-config
  rm -f "${pkgdir}"/usr/bin/cyglsa.dll
  rm -f "${pkgdir}"/usr/bin/cyglsa64.dll
  rm -f "${pkgdir}"/usr/bin/cygserver-config
  cp -rf "${srcdir}"/dest/usr/libexec "${pkgdir}"/usr/
  cp -rf "${srcdir}"/dest/usr/share "${pkgdir}"/usr/
}

package_msys2-runtime-devel() {
  pkgdesc="MSYS2 headers and libraries"
  groups=('msys2-devel')
  depends=("msys2-runtime=${pkgver}")
  options=('staticlibs' '!strip')
  conflicts=('libcatgets-devel')
  replaces=('libcatgets-devel')

  mkdir -p "${pkgdir}"/usr/bin
  cp -f "${srcdir}"/dest/usr/bin/msys-2.0.dbg "${pkgdir}"/usr/bin/
  cp -rLf "${srcdir}"/dest/usr/${CHOST}/include "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/include/iconv.h
  rm -f "${pkgdir}"/usr/include/unctrl.h
  # provided by libtirpc
  rm -fr "${pkgdir}"/usr/include/rpc/

  cp -rLf "${srcdir}"/dest/usr/${CHOST}/lib "${pkgdir}"/usr/
}

# return 0
# To hack on this:
# cd /c/repo-MSYS2/msys2-runtime/
# pushd src/build-i686-pc-msys
# LANG=C make && make -j1 DESTDIR=/c/repo-MSYS2/msys2-runtime/src/dest install
# popd
# makepkg -sRLf
# pacman -U msys2-runtime*.xz

# Quicker:
# open cmd.exe
# set "PATH=C:\\msys32\\usr\\bin;%PATH%"
# E:
# pushd E:\m2\repo-MSYS2\msys2-runtime\src\build-i686-pc-msys\i686-pc-msys\winsup\cygwin
# C:/msys32/usr/bin/bash -c "LANG=C && make"
# copy /y new-msys-2.0.dll C:\msys32\usr\bin\msys-2.0.dll
# popd
# C:
# C:/msys32/usr/bin/strace ls / > C:/strace.txt 2>&1
#
